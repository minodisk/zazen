<!DOCTYPE html>
<html>
<head>
  <title>zazen</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" media="all" href="docco.css" />
  <link rel="stylesheet" media="all" href="styles/style.css" />
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <script src="scripts/main.js"></script>
</head>
<body>
  <aside class="sidebar">
  
    <dl class="toc">
      <dt><a href="#"><span>zazen</span></a></dt>
      <dd><a href="https://github.com/minodisk/zazen" class="external"><span>GitHub Repositories</span></a></dd>
      <dt><a href="#"><span>Introduction</span></a></dt>
    
          <dd><a href="#install"><span>Install</span></a></dd>
          
          <dd><a href="#include"><span>Include</span></a></dd>
          
          <dt><a href="#apis"><span>APIs</span></a></dt>
          
          <dd><a href="#the-context-"><span>The(context)</span></a></dd>
          
          <dd><a href="#then-function-"><span>then(function)</span></a></dd>
          
          <dd><a href="#then-the-"><span>then(the)</span></a></dd>
          
          <dd><a href="#then-function-"><span>then([function, …])</span></a></dd>
          
          <dd><a href="#fail-function-"><span>fail(function)</span></a></dd>
          
          <dd><a href="#wait-delay-"><span>wait(delay)</span></a></dd>
          
          <dd><a href="#pomisify-function-"><span>pomisify(function)</span></a></dd>
          
          <dt><a href="#cookbook"><span>Cookbook</span></a></dt>
          
          <dd><a href="#with-underscore-or-lo-dash"><span>With underscore or lo-dash</span></a></dd>
          
          <dt><a href="#copyright"><span>Copyright</span></a></dt>
          
          <dd><a href="#distributions"><span>Distributions</span></a></dd>
          
          <dd><a href="#documentation-authers"><span>Documentation authers</span></a></dd>
          
    </dl>
  
  </aside>
  <div class="container">
    <div class="header">
      
        
        <h1 id="zazen">zazen</h1>
<p>zazenは<code>The</code>と<code>then</code>とその他の少しのキーワードで構成される、非同期プロセスを繋ぐためのライブラリです。</p>

        
      
    </div>

    
      <p><strong>Escape from callback hell</strong>
コールバックスタイルの非同期処理は深いネストのせいでリーダビリティを失い、
エラーハンドリングも煩雑になりがちです。
zazenはこれらの問題を解決するためのスマートな方法を提供します。</p>

      
        <div class='highlight'><pre><span class="hljs-keyword">var</span> zazen = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zazen'</span>)
  , The = zazen.The
  , fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  ;
The
  .wait(<span class="hljs-number">1000</span>)
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(reject, resolve)</span> {</span>
    fs.readFile(<span class="hljs-string">'data.json'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, result)</span> {</span>
      <span class="hljs-keyword">if</span> (err != <span class="hljs-literal">null</span>) {
        reject(err);
      } <span class="hljs-keyword">else</span> {
        resolve(result);
      }
    });
  })
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
    console.log(err); <span class="hljs-comment">// &gt; 'fail'</span>
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    console.log(<span class="hljs-number">3</span>);
  });</pre></div>
      
      <h3 id="install">Install</h3>
<pre><code class="lang-bash">npm install zazen
</code></pre>
<pre><code class="lang-bash">bower install zazen
</code></pre>

      
      <h3 id="include">Include</h3>
<p><strong>in Node</strong></p>
<pre><code><span class="hljs-keyword">var</span> zazen = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zazen'</span>)
  , The = zazen.The
  ;
</code></pre>
      
      <p><strong>in browser (standalone)</strong></p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"path/to/zazen.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">var</span> The = zazen.The;
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
</code></pre>

      
      <p><strong>in browser (jQuery plugin)</strong></p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"path/to/jquery.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"path/to/jquery.zazen.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">var</span> The = zazen.The;
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
</code></pre>

      
      <h2 id="apis">APIs</h2>

      
      <h3 id="the-context-">The(context)</h3>
<p><strong>束縛</strong>
zazenフロー中の<code>function</code>を<code>context</code>で束縛します。
<code>context</code>を渡さなかった場合や<code>The</code>を関数としてコールしなかった場合は<code>The</code>インスタンスが<code>context</code>となります。</p>

      
        <div class='highlight'><pre>The({ foo: <span class="hljs-string">'bar'</span> })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>; <span class="hljs-comment">//=&gt; { foo: 'bar' }</span>
  });</pre></div>
      
      
      
        <div class='highlight'><pre>The()
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>; <span class="hljs-comment">//=&gt; '[object the]'</span>
  });</pre></div>
      
      
      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>; <span class="hljs-comment">//=&gt; '[object the]'</span>
  });</pre></div>
      
      <p><strong>コンストラクタの同位性</strong>
<code>new</code>,<code>()</code>の有無によらず同じ機能を持ちます。</p>

      
        <div class='highlight'><pre><span class="hljs-keyword">new</span> The().then();</pre></div>
      
      
      
        <div class='highlight'><pre>The().then();</pre></div>
      
      
      
        <div class='highlight'><pre>The.then();</pre></div>
      
      <h3 id="then-function-">then(function)</h3>
<p><strong>resolve 引数</strong>
非同期プロセスや次のプロセスに値を渡す必要がある場合、<em>resolve</em>というキーワードの引数を設定します。
プロセスの完了時に<code>resolve()</code>をコールすることで次の<em>then</em>プロセスにヘッドが移ります。
また、<code>resolve()</code>の引数にセットした値は、次の<em>then</em>プロセスに引数として渡されます。</p>

      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve)</span> {</span>
    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      resolve(<span class="hljs-string">'done'</span>);
    }, <span class="hljs-number">1000</span>);
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arg)</span> {</span>
    console.log(arg); <span class="hljs-comment">// &gt; 'done'</span>
  });</pre></div>
      
      <p><strong>reject 引数</strong>
プロセス中でエラーハンドリングする場合、<em>reject</em>というキーワードの引数を設定します。
プロセスの失敗時に<code>reject()</code>をコールすることで次の<em>fail</em>プロセスにヘッドが移ります。
また、<code>reject()</code>の引数にセットした値は、次の<em>fail</em>プロセスに引数として渡されます。</p>

      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(reject)</span> {</span>
    <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).readFile(<span class="hljs-string">'data/null.json'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> {</span>
      <span class="hljs-keyword">if</span> (err != <span class="hljs-literal">null</span>) {
        reject(err);
      }
    });
  })
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
    console.log(err);
  });</pre></div>
      
      <p><strong>resolve, reject 引数の省略</strong>
同期プロセスで且つ次のプロセスに値を渡す必要がない場合、<em>resolve</em>というキーワードの引数を省略することができます。
また、プロセス中でエラーハンドリングをしない場合、<em>reject</em>というキーワードの引数を省略することができます。</p>

      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    console.log(<span class="hljs-number">1</span>); <span class="hljs-comment">// &gt; 1</span>
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    console.log(<span class="hljs-number">2</span>); <span class="hljs-comment">// &gt; 2</span>
  });</pre></div>
      
      <h3 id="then-the-">then(the)</h3>
<p><strong>the1 -&gt; the2 -&gt; the1</strong>
<code>then()</code>では別の<code>The</code>インスタンスをヘッドを移すこともできます。</p>

      
        <div class='highlight'><pre>The
  .then(
    The
      .wait(<span class="hljs-number">1000</span>)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        console.log(<span class="hljs-number">1</span>);
      })
      .wait(<span class="hljs-number">2000</span>)
  )
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    console.log(<span class="hljs-number">2</span>);
  });</pre></div>
      
      <h3 id="then-function-">then([function, …])</h3>
<p><strong>並列処理</strong>
<code>then()</code>に<code>Array&lt;Function&gt;</code>を渡すとそれらを並列なプロセスとして扱います。
全てのプロセスが完了するのを待って次の<em>then</em>プロセスにヘッドが移ります。</p>

      
        <div class='highlight'><pre>The
  .then([
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-string">'sync process'</span>;
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve)</span> {</span>
      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        resolve();
      }, <span class="hljs-number">1000</span>);
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve)</span> {</span>
      setTimeout(resolve, <span class="hljs-number">2000</span>);
    }
  ])
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-string">'will be passed 2sec'</span>;
  });</pre></div>
      
      <h3 id="fail-function-">fail(function)</h3>
<p><strong>エラーハンドリング</strong>
<em>then</em>プロセス中に<code>reject()</code>をコールした場合やエラーなどをキャッチした場合、次の<em>fail</em>プロセスにヘッドが移ります。
間の<em>then</em>プロセスはスキップされ、<em>fail</em>から後の<em>then</em>プロセスも実行されるません。</p>

      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(reject)</span> {</span>
    reject();
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* will be skipped */</span>
  })
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* will be called */</span>
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* won't be called */</span>
  });</pre></div>
      
      
      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'OMG!'</span>;
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* will be skipped */</span>
  })
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* will be called */</span>
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* won't be called */</span>
  });</pre></div>
      
      <p><strong>then へ復帰</strong>
<em>resolve</em>というキーワードを引数を設定し、<code>resolve()</code>をコールすることで次の<em>then</em>プロセスにヘッドが移ります。
また、<code>resolve()</code>の引数にセットした値は、次の<em>then</em>プロセスに引数として渡されます。</p>

      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(reject)</span> {</span>
    reject();
  })
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(resolve)</span> {</span>
    <span class="hljs-comment">/* do something to recover */</span>
    resolve();
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* will be called */</span>
  });</pre></div>
      
      <p><strong>fail から fail へ</strong>
<em>reject</em>というキーワードを引数を設定し、<code>reject()</code>をコールすることで次の<em>fail</em>プロセスにヘッドが移ります。
また、<code>reject()</code>の引数にセットした値は、次の<em>fail</em>プロセスに引数として渡されます。</p>

      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(reject)</span> {</span>
    reject();
  })
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(reject)</span> {</span>
    <span class="hljs-comment">/* give up recovering */</span>
    reject();
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* will be skipped */</span>
  })
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">/* will be called */</span>
  });</pre></div>
      
      <h3 id="wait-delay-">wait(delay)</h3>
<p><strong>遅延</strong>
設定したミリ秒後に次の<code>then</code>プロセスにヘッドが移ります。</p>

      
        <div class='highlight'><pre>The
  .wait(<span class="hljs-number">1000</span>)
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    console.log(<span class="hljs-string">'1sec left'</span>);
  });</pre></div>
      
      <p><strong>then で return</strong>
<em>then</em>プロセス中で<code>The.wait()</code>を<code>return</code>することで同じ効果を期待できます。
この方法はプロセスの実行時まで遅延するか否かを決定できない場合などに用います。</p>

      
        <div class='highlight'><pre>The
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.random() &lt; <span class="hljs-number">0.5</span>) {
      <span class="hljs-keyword">return</span> The.wait(<span class="hljs-number">1000</span>);
    }
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    console.log(<span class="hljs-string">'1sec left 50% of the time'</span>);
  });</pre></div>
      
      <h3 id="pomisify-function-">pomisify(function)</h3>
<p>zazenをNodeで使うとき、<code>promisify()</code>というユーティリティが役に立ちます。
これは<code>function (err, result) {}</code>のようなcallbackを引数とする非同期なNodeのmethodをzazenのスタイルにwrapします。</p>

      
        <div class='highlight'><pre><span class="hljs-keyword">var</span> promisify = zazen.promisify
  , readFile = promisify(<span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).readFile)
  ;
readFile(<span class="hljs-string">'data/a.json'</span>)
  .fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
    console.log(err);
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
    console.log(data);
  });</pre></div>
      
      <h2 id="cookbook">Cookbook</h2>

      
      <h3 id="with-underscore-or-lo-dash">With underscore or lo-dash</h3>

      
        <div class='highlight'><pre>The
  .parallel(_.map([<span class="hljs-string">'data/a.json'</span>, <span class="hljs-string">'data/b.json'</span>, <span class="hljs-string">'data/c.json'</span>], fs.readFile))
  .then(_.map, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(json)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(json);
  })
  .then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(objects)</span> {</span>
    console.log(objects);
  });</pre></div>
      
      <h2 id="copyright">Copyright</h2>

      
      <h3 id="distributions">Distributions</h3>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:center">development</th>
<th style="text-align:center">production</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Standalone</td>
<td style="text-align:center"><a href="https://raw.github.com/minodisk/zazen/master/jquery.zazen.js">zazen.js</a></td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:left">jQuery plugin</td>
<td style="text-align:center"><a href="https://raw.github.com/minodisk/zazen/master/jquery.zazen.js">jquery.zazen.js</a></td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>

      
      <h3 id="documentation-authers">Documentation authers</h3>
<p><a href="https://github.com/minodisk">Daisuke Mino</a></p>

      
  </div>
</body>
</html>
